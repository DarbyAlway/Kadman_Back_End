<!DOCTYPE html>
<html>
  <head>
    <title>Attendance LIFF App</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h2>Attendance Check</h2>
      <p id="status" class="loading">Loading...</p>
      <p id="quota" class="quota-box loading">Loading quota...</p>

      <form id="attendanceForm">
        <div class="days-container">
          <div class="days-title">Select Available Days</div>
          <div class="checkbox-item">
            <input type="checkbox" name="days" value="Tuesday" id="tuesday" />
            <label for="tuesday">Tuesday</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" name="days" value="Wednesday" id="wednesday" />
            <label for="wednesday">Wednesday</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" name="days" value="Thursday" id="thursday" />
            <label for="thursday">Thursday</label>
          </div>
        </div>

        <button type="submit">
          <span class="submit-text">Submit Attendance</span>
        </button>
      </form>

      <!-- Payment info after attendance -->
      <div id="paymentInfo" style="margin-top: 20px; text-align: center; display: none;">
        <img id="promptpayQR" src="" alt="PromptPay QR" style="width:200px;height:200px;" />
        <p id="paymentAmount" style="font-weight:bold; margin-top:10px;"></p>
      </div>
    </div>

    <script>
      const liffId = "2007876163-7dLrAMJr"; // Replace with your LIFF ID

      document.addEventListener('DOMContentLoaded', function() {
        const checkboxItems = document.querySelectorAll('.checkbox-item');
        checkboxItems.forEach(item => {
          const checkbox = item.querySelector('input[type="checkbox"]');
          item.addEventListener('click', function(e) {
            if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
            updateCheckboxState(item, checkbox.checked);
          });
          checkbox.addEventListener('change', function() {
            updateCheckboxState(item, this.checked);
          });
        });

        function updateCheckboxState(item, checked) {
          if (checked) item.classList.add('checked');
          else item.classList.remove('checked');
        }

        const observer = new MutationObserver(() => updateStatusStyling());
        observer.observe(document.getElementById('status'), {
          childList: true, subtree: true, characterData: true
        });

        function updateStatusStyling() {
          const status = document.getElementById('status');
          const text = status.textContent.toLowerCase();
          status.classList.remove('loading', 'success', 'error');
          if (text.includes('loading') || text.includes('sending')) status.classList.add('loading');
          else if (text.includes('success') || text.includes('thank you')) status.classList.add('success');
          else if (text.includes('error') || text.includes('failed')) status.classList.add('error');
        }
      });

      function getLayoutIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("layout_id");
      }

      async function main() {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const layoutId = getLayoutIdFromUrl();
        if (!layoutId) {
          document.getElementById("status").textContent = "Layout ID missing in URL.";
          return;
        }

        try {
          const profile = await liff.getProfile();
          const statusEl = document.getElementById("status");
          const quotaEl = document.getElementById("quota");

          statusEl.textContent = `Hello, ${profile.displayName}! Please select days and submit your attendance.`;

          // Fetch current quota from backend
          try {
            const quotaResponse = await fetch(`https://9b9651eb3664.ngrok-free.app/get_quota`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ lineID: profile.userId })
            });

            if (quotaResponse.ok) {
              const quotaData = await quotaResponse.json();
              quotaEl.textContent = `Your current attendance quota: ${quotaData.attendance}`;
              quotaEl.classList.remove('loading');
            } else {
              quotaEl.textContent = "Failed to fetch quota.";
              quotaEl.classList.remove('loading');
              quotaEl.classList.add('error');
            }
          } catch (err) {
            quotaEl.textContent = "Error fetching quota: " + err.message;
            quotaEl.classList.remove('loading');
            quotaEl.classList.add('error');
          }

          const form = document.getElementById("attendanceForm");
          const submitBtn = form.querySelector('button[type="submit"]');

          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const checkedDays = Array.from(form.elements["days"])
              .filter(cb => cb.checked)
              .map(cb => cb.value);

            if (checkedDays.length === 0) { alert("Please select at least one day."); return; }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span>Submitting...';
            statusEl.textContent = "Sending attendance...";

            try {
              const response = await fetch(
                `https://9b9651eb3664.ngrok-free.app/check_attendance/${layoutId}`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    userId: profile.userId,
                    displayName: profile.displayName,
                    days: checkedDays,
                  }),
                }
              );

              if (response.ok) {
                const result = await response.json();

                // Show QR and amount
                const paymentInfo = document.getElementById("paymentInfo");
                const promptpayQR = document.getElementById("promptpayQR");
                const paymentAmount = document.getElementById("paymentAmount");

                promptpayQR.src = `https://promptpay.io/0864395473.png`;
                paymentAmount.textContent = `Amount to pay: ${checkedDays.length * 100} THB`;

                paymentInfo.style.display = "block";

                statusEl.textContent = "Attendance checked successfully. Thank you!";
                form.reset();
                document.querySelectorAll('.checkbox-item').forEach(item => item.classList.remove('checked'));
              } else {
                statusEl.textContent = "Failed to check attendance.";
                const text = await response.text();
                console.error("Response body:", text);
              }
            } catch (error) {
              statusEl.textContent = "Error sending attendance: " + error.message;
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<span class="submit-text">Submit Attendance</span>';
            }
          });
        } catch (error) {
          document.getElementById("status").textContent =
            "Error getting profile: " + error.message;
        }
      }

      main();
    </script>
  </body>
</html>
