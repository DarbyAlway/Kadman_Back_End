<!DOCTYPE html>
<html>
  <head>
    <title>Attendance LIFF App</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h2>Attendance Check</h2>
      
      <div class="info-section">
        <div id="status" class="info-box default">Loading user information...</div>
        <div id="quota" class="info-box loading">
          <div class="quota-icon"></div>
          <span>Loading quota information...</span>
        </div>
      </div>

      <form id="attendanceForm">
        <div class="days-container">
          <div class="days-title">Select Available Days</div>
          
          <div class="checkbox-item">
            <input type="checkbox" name="days" value="Tuesday" id="tuesday" />
            <label for="tuesday">Tuesday</label>
          </div>
          
          <div class="checkbox-item">
            <input type="checkbox" name="days" value="Wednesday" id="wednesday" />
            <label for="wednesday">Wednesday</label>
          </div>
          
          <div class="checkbox-item">
            <input type="checkbox" name="days" value="Thursday" id="thursday" />
            <label for="thursday">Thursday</label>
          </div>
        </div>

        <button type="submit">
          <span class="submit-text">Submit Attendance</span>
        </button>
      </form>

      <div id="paymentInfo">
        <h3>Payment Required</h3>
        <img id="promptpayQR" src="" alt="PromptPay QR" width="200" height="200" />
        <div id="paymentAmount"></div>
      </div>
    </div>

    <script>
      const liffId = "2007876163-7dLrAMJr";

      document.addEventListener('DOMContentLoaded', function() {
        const checkboxItems = document.querySelectorAll('.checkbox-item');
        
        checkboxItems.forEach(item => {
          const checkbox = item.querySelector('input[type="checkbox"]');
          
          item.addEventListener('click', function(e) {
            if (e.target !== checkbox) {
              checkbox.checked = !checkbox.checked;
            }
            updateCheckboxState(item, checkbox.checked);
          });
          
          checkbox.addEventListener('change', function() {
            updateCheckboxState(item, this.checked);
          });
        });

        function updateCheckboxState(item, checked) {
          if (checked) {
            item.classList.add('checked');
          } else {
            item.classList.remove('checked');
          }
        }
      });

      function getLayoutIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("layout_id");
      }

      async function main() {
        await liff.init({ liffId });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const layoutId = getLayoutIdFromUrl();
        if (!layoutId) {
          document.getElementById("status").textContent = "Layout ID missing in URL.";
          document.getElementById("status").className = "info-box error";
          return;
        }

        try {
          const profile = await liff.getProfile();
          const statusEl = document.getElementById("status");
          const quotaEl = document.getElementById("quota");

          statusEl.textContent = `Hello, ${profile.displayName}! Please select your available days and submit.`;
          statusEl.className = "info-box success";

          // Fetch current quota
          try {
            const quotaResponse = await fetch(`https://5fced6e42c09.ngrok-free.app/get_quota`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ lineID: profile.userId })
            });

            if (quotaResponse.ok) {
              const quotaData = await quotaResponse.json();
              quotaEl.innerHTML = `
                <div class="quota-icon"></div>
                <span>Current attendance quota: ${quotaData.attendance}</span>
              `;
              quotaEl.className = "info-box success";
            } else {
              quotaEl.innerHTML = `
                <div class="quota-icon"></div>
                <span>Failed to fetch quota information</span>
              `;
              quotaEl.className = "info-box error";
            }
          } catch (err) {
            quotaEl.innerHTML = `
              <div class="quota-icon"></div>
              <span>Error loading quota: ${err.message}</span>
            `;
            quotaEl.className = "info-box error";
          }

          const form = document.getElementById("attendanceForm");
          const submitBtn = form.querySelector('button[type="submit"]');

          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const checkedDays = Array.from(form.elements["days"])
              .filter(cb => cb.checked)
              .map(cb => cb.value);

            if (checkedDays.length === 0) {
              alert("Please select at least one day.");
              return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span>Submitting...';
            statusEl.textContent = "Processing your attendance...";
            statusEl.className = "info-box loading";

            try {
              const response = await fetch(
                `https://5fced6e42c09.ngrok-free.app/check_attendance/${layoutId}`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    userId: profile.userId,
                    displayName: profile.displayName,
                    days: checkedDays,
                  }),
                }
              );

              if (response.ok) {
                const result = await response.json();
                const paymentInfo = document.getElementById("paymentInfo");
                const promptpayQR = document.getElementById("promptpayQR");
                const paymentAmount = document.getElementById("paymentAmount");

                promptpayQR.src = `https://promptpay.io/0864395473.png`;
                paymentAmount.textContent = `Amount: ${checkedDays.length * 100} THB`;

                paymentInfo.style.display = "block";

                statusEl.textContent = "Attendance submitted successfully! Please proceed with payment.";
                statusEl.className = "info-box success";
                
                form.reset();
                document.querySelectorAll('.checkbox-item').forEach(item => {
                  item.classList.remove('checked');
                });
              } else {
                statusEl.textContent = "Failed to submit attendance. Please try again.";
                statusEl.className = "info-box error";
                const text = await response.text();
                console.error("Response body:", text);
              }
            } catch (error) {
              statusEl.textContent = "Error submitting attendance: " + error.message;
              statusEl.className = "info-box error";
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<span class="submit-text">Submit Attendance</span>';
            }
          });
        } catch (error) {
          document.getElementById("status").textContent = "Error loading profile: " + error.message;
          document.getElementById("status").className = "info-box error";
        }
      }

      main();
    </script>
  </body>
</html>